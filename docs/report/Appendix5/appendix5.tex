\chapter{Code Examples}
\label{chap:codesamples}

This appendix contains code examples relevant to the discussion in the main body of the
report.

\newpage
\section{Intial Front End Dockerfile}
The initial \texttt{Dockerfile} of the client container added in the first sprint of
the development of the tool.

\begin{figure}[ht]
  \begin{lstlisting}[basicstyle=\small, breaklines=true]
    ### STAGE 1: Build ###

    # We label our stage as 'builder'
    FROM node:8-alpine as builder

    COPY package.json package-lock.json ./

    RUN npm set progress=false && npm config set depth 0 && npm cache clean --force

    ## Storing node modules on a separate layer will prevent unnecessary npm installs at each build
    RUN npm i && mkdir /ng-app && cp -R ./node_modules ./ng-app

    WORKDIR /ng-app

    COPY . .

    ## Build the angular app in production mode and store the artifacts in dist folder
    RUN $(npm bin)/ng build --prod --build-optimizer

    ### STAGE 2: Setup ###

    FROM nginx:1.13.3-alpine

    ## Copy our default nginx config
    COPY nginx/default.conf /etc/nginx/conf.d/

    ## Remove default nginx website
    RUN rm -rf /usr/share/nginx/html/*

    ## From 'builder' stage copy over the artifacts in dist folder to default nginx public folder
    COPY --from=builder /ng-app/dist /usr/share/nginx/html

    CMD ["nginx", "-g", "daemon off;"]
  \end{lstlisting}
  \caption{Intial Front End Dockerfile}
  \label{sample:clientdocker}
\end{figure}

\newpage
\section{Initial Back End Dockerfile}
The initial \texttt{Dockerfile} of the server\_node container added in the first sprint of
the development of the tool.

\begin{figure}[h!]
    \begin{lstlisting}[basicstyle=\small]
    FROM node:carbon
    WORKDIR /usr/src/app
    COPY package*.json ./
    RUN npm install
    COPY . .
    EXPOSE 3000
    CMD [ "npm", "start" ]
  \end{lstlisting}
  \caption{Back End Dockerfile}
  \label{sample:serverdocker}
\end{figure}

\newpage
\section{Intial Circle CI Config File}
The initial \texttt{.circleci/config.yml} added in the first sprint of the development.

\begin{figure}[h!]
  \begin{lstlisting}[basicstyle=\small, breaklines=true]
  version: 2
  jobs:
    build:
      machine: true

      working_directory: ~/repo

      steps:
        - checkout

        - run:
            name: install docker-compose
            command: |
              set -x
              sudo chown -R $(whoami) /usr/local/bin
              curl -L https://github.com/docker/compose/releases/download/1.11.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose

        - run:
            name: docker compose build image
            command: |
              set -x
              docker-compose build
              docker-compose up

        - run:
            name: unit tests
            command: |
              curl localhost

        # deploy only master branch
        - deploy:
            command: |
              if [ "${CIRCLE_BRANCH}" == "master" ]; then
                chmod +x scripts/deploy.sh
                ./scripts/deploy.sh
              fi
  \end{lstlisting}
  \caption{Initial Build Config File}
  \label{sample:circleci}
\end{figure}

\newpage
\section{Initial Dockerrun.aws.json file}
The initial version of the file specifying how containers should be linked together when running
in the production environment on AWS.

\begin{figure}[h!]
  \begin{lstlisting}[basicstyle=\small, breaklines=true]
  {
      "AWSEBDockerrunVersion": 2,
      "containerDefinitions": [
          {
              "name": "client",
              "image": "993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-client:latest",
              "memory": 128,
              "essential": true,
              "portMappings": [
                  {
                      "hostPort": 80,
                      "containerPort": 80
                  }
              ],
              "links": [
                  "server_node"
              ]
          },
          {
              "name": "server_node",
              "image": "993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-server:latest",
              "memory": 128,
              "essential": true,
              "links": [
                "database"
              ]
          },
          {
            "name": "database",
            "image": "mongo",
            "memory": 128,
            "essential": true,
            "portMappings": [
                {
                    "hostPort": 27017,
                    "containerPort": 27017
                }
            ]
          }
      ]
  }
  \end{lstlisting}
  \caption{Dockerrun.aws.json}
  \label{sample:dockerrunaws}
\end{figure}

\newpage
\section{Production Deployment Script}
The bash script performing the deployment from Circle CI to the production environment
hosted on AWS.

\begin{figure}[h!]
  \begin{lstlisting}[basicstyle=\small, breaklines=true]
  #!/bin/bash
  set -x
  set -e

  AWS_CONFIG_FILE=$HOME/.aws/config

  mkdir $HOME/.aws
  touch $AWS_CONFIG_FILE
  chmod 600 $AWS_CONFIG_FILE

  echo "[default]"                                     > $AWS_CONFIG_FILE
  echo "aws_access_key_id=$AWS_ACCESS_KEY_ID"         >> $AWS_CONFIG_FILE
  echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" >> $AWS_CONFIG_FILE

  $(aws ecr get-login --no-include-email --region eu-west-2)

  docker tag repo_client:latest 993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-client:latest
  docker tag repo_server_node:latest 993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-server:latest

  docker push 993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-client:latest
  docker push 993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-server:latest

  eb deploy prod-env
  \end{lstlisting}
  \caption{Production Deployment Script}
  \label{sample:deploy}
\end{figure}

\newpage
\section{Final Dockerrun.aws.json file}
The final version of the file specifying how Docker containers should be link with each other
when running in the production environment provided by AWS.
\begin{figure}[h!]
  \begin{lstlisting}[basicstyle=\tiny, breaklines=true]
{
    "AWSEBDockerrunVersion": 2,
    "volumes": [
      {
        "name": "mongo",
        "host": {
          "sourcePath": "/var/app/database"
        }
      }
    ],
    "containerDefinitions": [
        {
            "name": "client",
            "image": "993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-client:latest",
            "memory": 300,
            "essential": true,
            "portMappings": [
                {
                    "hostPort": 80,
                    "containerPort": 80
                }
            ],
            "links": [
                "server_node"
            ]
        },
        {
            "name": "server_node",
            "image": "993389244112.dkr.ecr.eu-west-2.amazonaws.com/quiz-tool-server:latest",
            "memory": 300,
            "essential": true,
            "links": [
              "database"
            ]
        },
        {
          "name": "database",
          "image": "mongo",
          "memory": 300,
          "essential": true,
          "mountPoints": [
              {
                "sourceVolume": "mongo",
                "containerPath": "/data/db"
              }
          ],
          "portMappings": [
              {
                  "hostPort": 27017,
                  "containerPort": 27017
              }
          ]
        }
    ]
}
\end{lstlisting}
\caption{Final Dockerrun.aws.json}
\label{sample:dockerrunawsfinal}
\end{figure}
